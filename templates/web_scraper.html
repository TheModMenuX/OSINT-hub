{% extends "base.html" %}

{% block title %}Web Scraper - OSINT Tools{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="cyber-card">
                <div class="cyber-card-header text-center">
                    <h2 class="mb-0">
                        <i class="fas fa-spider text-cyan"></i> Web Scraper
                    </h2>
                    <p class="text-light mt-2">Extract and analyze content from websites</p>
                </div>
                
                <div class="cyber-card-body">
                    <form method="POST" class="mb-4">
                        <div class="input-group cyber-input-group">
                            <span class="input-group-text cyber-input-addon">
                                <i class="fas fa-link"></i>
                            </span>
                            <input type="url" class="form-control cyber-input" 
                                   name="url" placeholder="Enter URL to scrape (e.g., https://example.com)" 
                                   value="{{ url or '' }}" required>
                            <button class="btn cyber-btn" type="submit">
                                <i class="fas fa-spider"></i> Scrape
                            </button>
                        </div>
                        <small class="form-text text-muted">
                            <i class="fas fa-info-circle"></i> 
                            This tool extracts main text content from web pages for analysis
                        </small>
                    </form>

                    {% if results %}
                    <div class="results-section">
                        <h4 class="text-cyan mb-4">
                            <i class="fas fa-file-alt"></i> Scraping Results for "{{ url }}"
                        </h4>
                        
                        <div class="row g-4">
                            <!-- Metadata -->
                            <div class="col-12">
                                <div class="info-card">
                                    <h5 class="info-card-title">
                                        <i class="fas fa-info-circle"></i> Page Information
                                    </h5>
                                    <div class="info-card-body">
                                        <div class="info-row">
                                            <span class="info-label">URL:</span>
                                            <span class="info-value">
                                                <a href="{{ results.url }}" target="_blank" class="text-cyan">
                                                    {{ results.url }}
                                                    <i class="fas fa-external-link-alt"></i>
                                                </a>
                                            </span>
                                        </div>
                                        <div class="info-row">
                                            <span class="info-label">Scraped At:</span>
                                            <span class="info-value">{{ results.timestamp }}</span>
                                        </div>
                                        <div class="info-row">
                                            <span class="info-label">Content Length:</span>
                                            <span class="info-value">
                                                <span class="badge cyber-badge">
                                                    {{ results.content|length }} characters
                                                </span>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Content -->
                            <div class="col-12">
                                <div class="info-card">
                                    <h5 class="info-card-title">
                                        <i class="fas fa-file-text"></i> Extracted Content
                                    </h5>
                                    <div class="info-card-body">
                                        {% if results.content and not results.content.startswith('Error') %}
                                        <div class="content-container">
                                            <div class="content-text">
                                                {{ results.content|truncate(5000) }}
                                            </div>
                                            {% if results.content|length > 5000 %}
                                            <div class="mt-3">
                                                <button class="btn cyber-btn-outline" onclick="showFullContent()">
                                                    <i class="fas fa-expand"></i> Show Full Content
                                                </button>
                                            </div>
                                            {% endif %}
                                        </div>
                                        
                                        <!-- Hidden full content -->
                                        <div id="fullContent" class="content-container d-none">
                                            <div class="content-text">
                                                {{ results.content }}
                                            </div>
                                            <div class="mt-3">
                                                <button class="btn cyber-btn-outline" onclick="hideFullContent()">
                                                    <i class="fas fa-compress"></i> Show Less
                                                </button>
                                                <button class="btn cyber-btn-outline" onclick="copyContent()">
                                                    <i class="fas fa-copy"></i> Copy Content
                                                </button>
                                            </div>
                                        </div>
                                        {% else %}
                                        <div class="alert alert-warning cyber-alert">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            {{ results.content }}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <!-- Actions -->
                            <div class="col-12">
                                <div class="info-card">
                                    <h5 class="info-card-title">
                                        <i class="fas fa-tools"></i> Analysis Tools
                                    </h5>
                                    <div class="info-card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <button class="btn cyber-btn-outline w-100 mb-2" onclick="analyzeKeywords()">
                                                    <i class="fas fa-key"></i> Extract Keywords
                                                </button>
                                            </div>
                                            <div class="col-md-6">
                                                <button class="btn cyber-btn-outline w-100 mb-2" onclick="countWords()">
                                                    <i class="fas fa-calculator"></i> Word Count
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <!-- Analysis Results -->
                                        <div id="analysisResults" class="mt-3 d-none">
                                            <div class="alert alert-info cyber-alert">
                                                <div id="analysisContent"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4 text-center">
                            <small class="text-muted">
                                <i class="fas fa-shield-alt"></i> 
                                Always ensure you have permission to scrape websites. Respect robots.txt and rate limits.
                            </small>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function showFullContent() {
    document.querySelector('.content-container').classList.add('d-none');
    document.getElementById('fullContent').classList.remove('d-none');
}

function hideFullContent() {
    document.querySelector('.content-container').classList.remove('d-none');
    document.getElementById('fullContent').classList.add('d-none');
}

function copyContent() {
    const content = document.querySelector('#fullContent .content-text').textContent;
    navigator.clipboard.writeText(content).then(() => {
        alert('Content copied to clipboard!');
    });
}

function analyzeKeywords() {
    const content = document.querySelector('.content-text').textContent;
    const words = content.toLowerCase().match(/\b\w+\b/g) || [];
    const wordCount = {};
    
    words.forEach(word => {
        if (word.length > 3) {
            wordCount[word] = (wordCount[word] || 0) + 1;
        }
    });
    
    const sortedWords = Object.entries(wordCount)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 10);
    
    let result = '<strong>Top Keywords:</strong><br>';
    sortedWords.forEach(([word, count]) => {
        result += `<span class="badge cyber-badge me-1">${word} (${count})</span>`;
    });
    
    showAnalysisResult(result);
}

function countWords() {
    const content = document.querySelector('.content-text').textContent;
    const words = content.match(/\b\w+\b/g) || [];
    const chars = content.length;
    const sentences = content.split(/[.!?]+/).length - 1;
    
    const result = `
        <strong>Content Statistics:</strong><br>
        Words: <span class="badge cyber-badge">${words.length}</span>
        Characters: <span class="badge cyber-badge">${chars}</span>
        Sentences: <span class="badge cyber-badge">${sentences}</span>
    `;
    
    showAnalysisResult(result);
}

function showAnalysisResult(content) {
    document.getElementById('analysisContent').innerHTML = content;
    document.getElementById('analysisResults').classList.remove('d-none');
}
</script>
{% endblock %}
